<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="chrome=1" />
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Emoji Piano</title>

		<link rel="stylesheet" type="text/css" href="keyboard.css">

		<link rel="apple-touch-icon" sizes="57x57" href="wat_icons/apple-touch-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="wat_icons/apple-touch-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="wat_icons/apple-touch-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="wat_icons/apple-touch-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="wat_icons/apple-touch-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="wat_icons/apple-touch-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="wat_icons/apple-touch-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="wat_icons/apple-touch-icon-152x152.png">
		<link rel="apple-touch-icon" sizes="180x180" href="wat_icons/apple-touch-icon-180x180.png">
		<link rel="icon" type="image/png" href="wat_icons/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="wat_icons/android-chrome-192x192.png" sizes="192x192">
		<link rel="icon" type="image/png" href="wat_icons/favicon-96x96.png" sizes="96x96">
		<link rel="icon" type="image/png" href="wat_icons/favicon-16x16.png" sizes="16x16">
		<meta name="msapplication-TileColor" content="#2b5797">
		<meta name="msapplication-TileImage" content="wat_icons/mstile-144x144.png">
		<meta name="theme-color" content="#ffffff">

		<meta property="og:title" content="Emoji Piano" />
		<meta property="og:type" content="website" />
		<meta property="og:url" content="https://webaudiotech.com/sites/emoji_piano" />
		<meta property="og:image" content="https://webaudiotech.com/sites/emoji_piano/title_image.png" />
		<meta property="og:description" content="Share melodies via emojis." />

	</head>

	<body id="body">
		<div style="text-align:center;">
			<h1 style="margin: 0px;">Emoji Piano</h1><br>
			<p style="margin: 0px;">Share melodies via emojis.</p>
		</div>
		<div style="text-align:center;">
			<textarea cols="100" id="textarea" style="font-size: 18pt; margin-top: 15px;"></textarea>
		</div>
		<div style="text-align:center; margin: 15px;" id="controls">
			<input id="button_play" type="button" value="Play">
			<input id="button_halve_note_length" type="button" value="Note Length / 2">
			<input id="button_dot_note_length" type="button" value="Dot Note">
			<input id="button_double_note_length" type="button" value="Note Length + 1/4">
			<input id="button_insert_rest" type="button" value="Insert Rest">
			<input id="button_clear" type="button" value="Clear">
		</div>
		<div id="piano_container"></div>
		<div style="text-align:center; margin-top: 30px;">
			<p style="margin: 0px;">To share your melody, copy the emojis from the textarea above or copy this link:<br>
				<span><a id="score_link" href="https://webaudiotech.com/sites/emoji_piano?score=">https://webaudiotech.com/sites/emoji_piano?score=</a></span>
			</p>
		</div>
		<div style="text-align:center; margin-top: 30px;">
			<a href="https://webaudiotech.com">
				<img style="width: 75px;" src="https://webaudiotech.com/wp-content/uploads/2015/12/cropped-wat_logo_transparent.png">
			</a>
		</div>


		<script src="claviature.js"></script>

		<script>

			var g = function(id){

				return document.getElementById(id);

			}

			var getFrequency = function(note, detune, masterTune, transpose){

				// note a with concert pitch is on key 49, since we start at key 0, it is key 48
				var power = note - 48 + transpose + detune;

				var frequency = masterTune * (Math.pow(2,(power/12)));

				return frequency;

			}

			var QueryString = function () {
			  // This function is anonymous, is executed immediately and
			  // the return value is assigned to QueryString!
			  var query_string = {};
			  var query = window.location.search.substring(1);
			  var vars = query.split("&");
			  for (var i=0;i<vars.length;i++) {
				var pair = vars[i].split("=");
					// If first entry with this name
				if (typeof query_string[pair[0]] === "undefined") {
				  query_string[pair[0]] = pair[1];
					// If second entry with this name
				} else if (typeof query_string[pair[0]] === "string") {
				  var arr = [ query_string[pair[0]], pair[1] ];
				  query_string[pair[0]] = arr;
					// If third or later entry with this name
				} else {
				  query_string[pair[0]].push(pair[1]);
				}
			  }
				return query_string;
			} ();

			var refreshScoreLink = function(score){

				var score_link = g("score_link");
				var link = "https://webaudiotech.com/sites/emoji_piano?score=" + score;
				score_link.innerHTML = link;
				score_link.href = link;

			}

			var play = function(){

				var scoreString = textarea.value;

				var chars = Array.from(scoreString);
				console.log(chars);

				var keys = chars.map(function(char){

					if (char == "â–¸"){
						return -2;
					}

					else if (char == "â—‚"){
						return -3;
					}

					else if (char == "â—"){
						return -4;
					}

					//somewhat unnecessary, but for code readability
					else if (char == "â—¼ï¸"){
						return -1;
					}

					else {
						return CLAVIATURE.config.custom_key_names.indexOf(char);
					}

				});

				playKeys(keys);

				console.log(keys);

			};

			var bpm = 120;

			var textarea = g("textarea");

			var context = new AudioContext();
			var oscs = [];
			var masterGain = context.createGain();
			masterGain.connect(context.destination);
			masterGain.gain.value = 0.3;

			var notes = [];
			var isPlaying = false;

			CLAVIATURE.create({
				container_id: "piano_container",
				labels: true,
				custom_key_names: [
					'ðŸ¶', 'ðŸ±', 'ðŸ­', 'ðŸ¹', 'ðŸ°', 'ðŸ»', 'ðŸ¼', 'ðŸ¨', 'ðŸ¯', 'ðŸ®',
					'ðŸ·', 'ðŸ½', 'ðŸ¸', 'ðŸ™', 'ðŸµ', 'ðŸš', 'ðŸ™‰', 'ðŸ™Š', 'ðŸ’', 'ðŸ”',
					'ðŸ§', 'ðŸ¦', 'ðŸ¤', 'ðŸ£', 'ðŸ¥', 'ðŸº', 'ðŸ—', 'ðŸ´', 'ðŸ', 'ðŸ›',
					'ðŸŒ', 'ðŸž', 'ðŸœ', 'ðŸ', 'ðŸ¢', 'ðŸ ', 'ðŸŸ', 'ðŸ¡', 'ðŸ¬', 'ðŸ³',
					'ðŸ‹', 'ðŸŠ', 'ðŸ†', 'ðŸ…', 'ðŸƒ', 'ðŸ‚', 'ðŸ„', 'ðŸª', 'ðŸ«', 'ðŸ˜',
					'ðŸ', 'ðŸ', 'ðŸ‘', 'ðŸŽ', 'ðŸ–', 'ðŸ€', 'ðŸ', 'ðŸ“', 'ðŸ•', 'ðŸ©',
					'ðŸˆ', 'ðŸ‡', 'ðŸ¾', 'ðŸ‡', 'ðŸ’', 'ðŸŒµ', 'ðŸ‰', 'ðŸŒ²', 'ðŸŒ³', 'ðŸŒ´',
					'ðŸŒ±', 'ðŸŒ¿', 'ðŸ', 'ðŸ€', 'ðŸ…', 'ðŸŽ‹', 'ðŸƒ', 'ðŸ‚', 'ðŸ', 'ðŸŒ¾',
					'ðŸŒº', 'ðŸŒ»', 'ðŸŒ¹', 'ðŸŒ·', 'ðŸŒ¼', 'ðŸŒ¸', 'ðŸ’', 'ðŸ„',
					'ðŸ‹', 'ðŸŒ', 'ðŸ“', 'ðŸ‘', 'ðŸ†', 'ðŸŒ½'
				],
				onactivate: function(key, note){

					keyDown(key, note);

				},
				ondeactivate: function(key, note){

					keyUp(key, note);

				}
			});


			var midiAccess;

			//start up midi api
			var onMIDIInit = function(midi) {
				midiAccess = midi;
				console.log("MIDI initialized!");

				var inputs = midiAccess.inputs;

				if (inputs.size === 0){
					console.log("No MIDI input devices present.")
				}

				else { // Hook the message handler for all MIDI inputs

					console.log("MIDI initialized and ready. There are " + inputs.size + " inputs!");

					for (var input of inputs){
						console.log(input[1]);
						console.log("Found MIDI input: " + input[1].manufacturer + ", " + input[1].name);
						input[1].onmidimessage = MIDIMessageEventHandler;
					}



				}
			};

			var onMIDIReject = function(err) {
				console.log("The MIDI system failed to start.");
			};

			console.log("Requesting MIDI access");

			if (navigator.requestMIDIAccess){
				navigator.requestMIDIAccess().then( onMIDIInit, onMIDIReject );
			}

			else {
				console.log("No MIDI support present in your browser.")
			}


			var MIDIMessageEventHandler = function(event) {

				// Mask off the lower nibble (MIDI channel, which we don't care about)
				switch (event.data[0] & 0xf0) {

					case 0x90:
						if (event.data[2] != 0) {  // if velocity != 0, this is a note-on message
							keyDown(event.data[1]-21);
							return;
						}

						// if velocity == 0, fall thru: it's a note-off.  MIDI's weird, ya'll.
					case 0x80:
						keyUp(event.data[1]-21);
						return;
				}

			};


			var keyDown = function(key){

				insertAtCaret(CLAVIATURE.config.custom_key_names[key]);
				refreshScoreLink(textarea.value);

				var osc = context.createOscillator();
				osc.type = "triangle";
				osc.frequency.value = getFrequency(key, 0, 440, 0);
				osc.connect(masterGain);
				osc.start();
				oscs[key] = osc;

			}

			var keyUp = function(key, note){

				if (oscs[key]){

					oscs[key].stop();
					delete(oscs[key]);

				}

			}


			var insertAtCaret = function(txtToAdd){

				var caretPos = textarea.selectionStart;
				var textAreaTxt = textarea.value;
				textarea.value = textAreaTxt.substring(0, caretPos) + txtToAdd + textAreaTxt.substring(caretPos);
				textarea.selectionStart = caretPos + txtToAdd.length;
				textarea.selectionEnd = caretPos + txtToAdd.length;

			}


			g("button_clear").addEventListener("click", function(){

				textarea.value = "";
				refreshScoreLink("");

			});

			g("button_play").addEventListener("click", function(){

				play();

			});


			g("button_insert_rest").addEventListener("click", function(){

				insertAtCaret("â—¼ï¸");
				refreshScoreLink(textarea.value);

			});


			g("button_double_note_length").addEventListener("click", function(){

				insertAtCaret("â–¸");
				refreshScoreLink(textarea.value);

			});


			g("button_halve_note_length").addEventListener("click", function(){

				insertAtCaret("â—‚");
				refreshScoreLink(textarea.value);

			});


			g("button_dot_note_length").addEventListener("click", function(){

				insertAtCaret("â—");
				refreshScoreLink(textarea.value);

			});


			var playKeys = function(keys){

				if (isPlaying){
					return;
				}

				else {
					isPlaying = true;
				}

				var quarterNoteTime = 60 / bpm;
				var note_start_time = context.currentTime + 0.2;

				var length = keys.length;

				notes = [];

				for (var i = 0; i < length; i++){

					//if note is to be shortened or prolongened, it already has been done by while loop
					if (keys[i] < -1){
						continue;
					}

					// create tone if note is not a rest
					if (keys[i] > -1){
						var osc = context.createOscillator();
						osc.type = "triangle";
						osc.frequency.value = getFrequency(keys[i], 0, 440, 0);
						osc.start(note_start_time);

						var gain = context.createGain();

						osc.connect(gain);
						gain.connect(masterGain);

						notes.push({key: keys[i], start_time: note_start_time});

					}

					// check for manipulation of note/rest length
					var j = i;
					var note_length = quarterNoteTime;

					while (keys[j+1] < -1){

						if (keys[j+1] == -2){
							note_length += quarterNoteTime;
						}

						if (keys[j+1] == -3){
							note_length /= 2;
						}

						// dotted note length = (2 - ( 1 / Math.pos(2, n) ) , when n = number of dots after a note
						// compare https://en.wikipedia.org/wiki/Dotted_note
						// currently, we do not check how many dots there are after a note, so we'll always multiply by the half of the complete note length
						// this could be improved!
						if (keys[j+1] == -4){
							note_length += 0.5 * note_length;
						}

						j++;

					}

					var note_stop_time = note_start_time + note_length - (note_length/5);

					if (keys[i] > -1){
						osc.stop(note_stop_time);
						notes[notes.length - 1].stop_time = note_stop_time;

						gain.gain.setValueAtTime(gain.gain.value, note_stop_time - 0.03);
						gain.gain.exponentialRampToValueAtTime(0.0001, note_stop_time);

					}

					// this will also be added, if a rest is given
					note_start_time += note_length;
				}

				draw();

			}


			var draw = function(){

				for (var k = 0; k < 88; k++){

					g("b" + k).classList.remove("active");

				}

				var time = context.currentTime;
				var index = 0;

				while ((index < notes.length - 1) && (notes[index].stop_time <= time)){

					index++;

				}

				if (notes[index].start_time <= time && notes[index].stop_time >= time){
					g("b" + notes[index].key).classList.add("active");
				}

				if (index == notes.length - 1 && notes[index].stop_time < time){
					isPlaying = false;
					return;
				}

				requestAnimationFrame(draw);

			}


			var replaceLegacyEmojis = function(score){

				var map = {
					"ðŸ”´": "â—",
					"â–¶ï¸": "â–¸",
					"â—€ï¸": "â—‚",

					"ðŸ™ˆ": "ðŸš",
					'ðŸŽ„': 'ðŸ‰',
					'ðŸ•': 'ðŸ',
					'ðŸŽ': 'ðŸ…',
					'ðŸ²': 'ðŸ’',
					'ðŸ‰': 'ðŸ‡',

					//in future, when Firefox supports Unicode 9.0.0 emojis
					//'ðŸ™‰': 'ðŸ¦',
					//'ðŸ™Š': 'ðŸ¦Œ',
					//'ðŸ½': 'ðŸ¦'
					//ðŸ¦…ðŸ¦‰ðŸ¦ŽðŸ¦ˆðŸ¦ðŸ¦‘ðŸ¦‹

				};

				for (key in map){
					while (score.indexOf(key) > -1){
						console.log("Replacing " + key + " with " + map[key]);
						score = score.replace(key, map[key]);
					}
				}

				return score;

			}


			if (QueryString.score){

				var score = decodeURI(QueryString.score);
				score = replaceLegacyEmojis(score);

				g("textarea").value = score;
				refreshScoreLink(score);

			}

			if (QueryString.bpm){

				var value = parseInt(QueryString.bpm);

				if (!isNaN(value) && value >= 30 && value <= 200){

					bpm = value;

				}

			}

			if (QueryString.autoplay && QueryString.autoplay == "true"){

				play();

			}

		</script>


	</body>
</html>
